# Copyright (c) Microsoft Corporation.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

trigger: none
pr: none
schedules:
  - cron: '0 16 * * Mon,Wed,Fri'
    displayName: Sync from upstream three times a week
    branches:
      include:
        - microsoft/main
    always: true

variables:
  - group: Microsoft-GoLang-bot

jobs:
  - job: Sync
    pool:
      vmImage: ubuntu-20.04
    workspace:
      clean: all
    steps:
      - template: /microsoft/pipeline/checkout-unix-task.yml

      # Initialize stage 0 toolset ahead of time so we can track timing data separately from the Git
      # operations. When we call this script again later, it won't download Go again.
      - script: microsoft/init-stage0.sh
        displayName: Init stage 0 Go toolset

      - script: |
          set -ex
          git config --global user.name 'microsoft-golang-bot'
          git config --global user.email 'microsoft-golang-bot@users.noreply.github.com'

          # Set up Go toolset env vars by sourcing init script.
          . microsoft/init-stage0.sh

          "$stage0_dir/go/bin/go" run microsoft/sync/sync-upstream-refs.go \
            -origin https://microsoft-golang-bot:$(BotAccount-microsoft-golang-bot-PAT)@github.com/microsoft/go \
            -to https://microsoft-golang-bot:$(BotAccount-microsoft-golang-bot-PAT)@github.com/microsoft-golang-bot/go \
            -github-pat $(BotAccount-microsoft-golang-bot-PAT) \
            -github-pat-reviewer $(BotAccount-microsoft-golang-review-bot-PAT) \
            -b master
        displayName: Sync
