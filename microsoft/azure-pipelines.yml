# Copyright (c) Microsoft Corporation.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

trigger:
  - microsoft/*
pr:
  - microsoft/*

stages:
  - stage: Build
    jobs:
      - template: pipeline/matrix-jobs.yml
        parameters:
          builders:
            - { os: linux, arch: amd64, config: buildandpack }
            - { os: linux, arch: amd64, config: devscript }
            - { os: linux, arch: amd64, config: test }
            # Upstream builders.
            - { os: linux, arch: amd64, config: clang }
            - { os: linux, arch: amd64, config: longtest }
            - { os: linux, arch: amd64, config: nocgo }
            - { os: linux, arch: amd64, config: noopt }
            - { os: linux, arch: amd64, config: race }
            # - { os: linux, arch: amd64, config: racecompile } https://github.com/microsoft/go/issues/54
            - { os: linux, arch: amd64, config: regabi }
            - { os: linux, arch: amd64, config: ssacheck }
            - { os: linux, arch: amd64, config: staticlockranking }

  - ${{ if and(ne(variables['System.TeamProject'], 'public'), ne(variables['Build.Reason'], 'PullRequest')) }}:
    - stage: Publish
      dependsOn: Build
      jobs:
        - job: Publish
          pool:
            vmImage: ubuntu-20.04
          variables:
            blobDestinationUrl: 'https://golangartifacts.blob.core.windows.net/microsoft/$(Build.SourceBranchName)/$(Build.BuildNumber)'
          steps:
            - checkout: none

            - download: current
              artifact: Binaries Signed
              displayName: 'Download: Binaries Signed'

            - task: AzureCLI@2
              displayName: Upload to blob storage
              inputs:
                azureSubscription: GoLang
                scriptType: bash
                scriptLocation: inlineScript
                failOnStandardError: true
                inlineScript: |
                  az storage copy -s "$(Pipeline.Workspace)/Binaries Signed/*" -d '$(blobDestinationUrl)'

            - script: |
                echo 'Generated links to artifacts in blob storage:'
                echo ''
                cd "$(Pipeline.Workspace)/Binaries Signed/"
                for f in *; do
                  echo "$(blobDestinationUrl)/$f"
                done
              displayName: Show uploaded URLs
