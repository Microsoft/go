From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Quim Muntal <qmuntaldiaz@microsoft.com>
Date: Tue, 24 May 2022 14:12:57 +0000
Subject: [PATCH] Move boring.Cache to backend/bcache

---
 .../internal/{boring => backend/bcache}/cache.go       |  2 +-
 .../internal/{boring => backend/bcache}/cache_test.go  |  2 +-
 src/crypto/internal/backend/bcache/stub.s              | 10 ++++++++++
 src/runtime/mgc.go                                     |  4 ++--
 4 files changed, 14 insertions(+), 4 deletions(-)
 rename src/crypto/internal/{boring => backend/bcache}/cache.go (99%)
 rename src/crypto/internal/{boring => backend/bcache}/cache_test.go (99%)
 create mode 100644 src/crypto/internal/backend/bcache/stub.s

diff --git a/src/crypto/internal/boring/cache.go b/src/crypto/internal/backend/bcache/cache.go
similarity index 99%
rename from src/crypto/internal/boring/cache.go
rename to src/crypto/internal/backend/bcache/cache.go
index 476e47706c9..6d6d7982a09 100644
--- a/src/crypto/internal/boring/cache.go
+++ b/src/crypto/internal/backend/bcache/cache.go
@@ -2,7 +2,7 @@
 // Use of this source code is governed by a BSD-style
 // license that can be found in the LICENSE file.
 
-package boring
+package bcache
 
 import (
 	"sync/atomic"
diff --git a/src/crypto/internal/boring/cache_test.go b/src/crypto/internal/backend/bcache/cache_test.go
similarity index 99%
rename from src/crypto/internal/boring/cache_test.go
rename to src/crypto/internal/backend/bcache/cache_test.go
index f9ccb74f6fd..8b2cf3d0941 100644
--- a/src/crypto/internal/boring/cache_test.go
+++ b/src/crypto/internal/backend/bcache/cache_test.go
@@ -2,7 +2,7 @@
 // Use of this source code is governed by a BSD-style
 // license that can be found in the LICENSE file.
 
-package boring
+package bcache
 
 import (
 	"fmt"
diff --git a/src/crypto/internal/backend/bcache/stub.s b/src/crypto/internal/backend/bcache/stub.s
new file mode 100644
index 00000000000..d2a6c5d6b84
--- /dev/null
+++ b/src/crypto/internal/backend/bcache/stub.s
@@ -0,0 +1,10 @@
+// Copyright 2017 The Go Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style
+// license that can be found in the LICENSE file.
+
+// registerCache is declared in cache.go without a body.
+// It's provided by package runtime,
+// but the go command doesn't know that.
+// Having this assembly file keeps the go command
+// from complaining about the missing body
+// (because the implementation might be here).
diff --git a/src/runtime/mgc.go b/src/runtime/mgc.go
index 5c044f0d874..3b8b8a410c3 100644
--- a/src/runtime/mgc.go
+++ b/src/runtime/mgc.go
@@ -1569,14 +1569,14 @@ func gcResetMarkState() {
 // Hooks for other packages
 
 var poolcleanup func()
-var boringCaches []unsafe.Pointer // for crypto/internal/boring
+var boringCaches []unsafe.Pointer // for crypto/internal/backend/bcache
 
 //go:linkname sync_runtime_registerPoolCleanup sync.runtime_registerPoolCleanup
 func sync_runtime_registerPoolCleanup(f func()) {
 	poolcleanup = f
 }
 
-//go:linkname boring_registerCache crypto/internal/boring.registerCache
+//go:linkname boring_registerCache crypto/internal/backend/bcache.registerCache
 func boring_registerCache(p unsafe.Pointer) {
 	boringCaches = append(boringCaches, p)
 }
