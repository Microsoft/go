From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: qmuntal <qmuntaldiaz@microsoft.com>
Date: Thu, 8 Jun 2023 14:17:13 +0200
Subject: [PATCH] Update default go.env

---
 go.env                                           | 6 ++++--
 src/cmd/go/script_test.go                        | 1 +
 src/cmd/go/testdata/script/gotoolchain_local.txt | 8 +-------
 3 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/go.env b/go.env
index 6ff2b921d464bc..4aca2ff2c63dbc 100644
--- a/go.env
+++ b/go.env
@@ -7,6 +7,8 @@
 GOPROXY=https://proxy.golang.org,direct
 GOSUMDB=sum.golang.org
 
-# Automatically download newer toolchains as directed by go.mod files.
+# Use the locally installed Go toolchain, never downloading a different one.
+# Upstream uses `GOTOOLCHAIN=auto` instead, but `auto` can download and switch
+# to a non-MSFT Go toolchain, and we want to avoid that.
 # See https://go.dev/doc/toolchain for details.
-GOTOOLCHAIN=auto
+GOTOOLCHAIN=local
diff --git a/src/cmd/go/script_test.go b/src/cmd/go/script_test.go
index a2c1087bd81d3e..7c8948a94b63a1 100644
--- a/src/cmd/go/script_test.go
+++ b/src/cmd/go/script_test.go
@@ -246,6 +246,7 @@ func scriptEnv(srv *vcstest.Server, srvCertFile string) ([]string, error) {
 		"goversion=" + version,
 		"CMDGO_TEST_RUN_MAIN=true",
 		"HGRCPATH=",
+		"GOTOOLCHAIN=auto", // Temporary workaround for #60685.
 		"newline=\n",
 	}
 
diff --git a/src/cmd/go/testdata/script/gotoolchain_local.txt b/src/cmd/go/testdata/script/gotoolchain_local.txt
index 313c5415015764..0e08207f451714 100644
--- a/src/cmd/go/testdata/script/gotoolchain_local.txt
+++ b/src/cmd/go/testdata/script/gotoolchain_local.txt
@@ -5,14 +5,8 @@
 env TESTGO_VERSION=go1.500
 env TESTGO_VERSION_SWITCH=switch
 
-# Default setting should be auto
-env GOTOOLCHAIN=
-go env GOTOOLCHAIN
-stdout auto
-go env
-stdout GOTOOLCHAIN=.?auto.?  # maybe quoted
-
 # GOTOOLCHAIN=auto runs default toolchain without a go.mod or go.work
+env GOTOOLCHAIN=auto
 go version
 stdout go1.500
 
