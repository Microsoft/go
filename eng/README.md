# `eng`: the Microsoft infrastructure to build Go

This directory contains build infrastructure files that Microsoft uses to build
Go Docker images.

The directory name, "eng", is short for "engineering". This name is used because
it matches the engineering directory used in microsoft/go, and also because
auto-updates to the "eng/common" directory only work with this absolute
location.

## Prerequisites

* [PowerShell 6+](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell)

## Building the Docker images

Run `pwsh eng/build.ps1` in the root of the repo, or `pwsh build.ps1` in `eng`.

## Updating the Dockerfiles

Additional prerequisites:
* `awk`
* `jq`

Run the `/eng/update-dockerfiles.sh` script in Bash.

This script wraps the upstream script `/apply-templates.sh`, reusing its
functionality. This also imposes the `jq` and `awk` requirements. Using the
upstream script makes it more likely that this repo will stay up to date when
the templates change in the upstream repo.

The Dockerfiles are checked into the repo after every update, so running this
script is not necessary to simply build the Docker images.

It may seem unusual that even though our Dockerfiles are created by a script
based on a JSON file, they are also checked in. This is done to match the
standard approach to Docker: Dockerfiles are *always* checked in, enabling users
to easily run `docker build .` to reproduce the result without complicated
repo-specific tooling being involved.

### Updating to a new build of Go

Auto-update is not yet implemented:
[#162](https://github.com/microsoft/go/issues/162). It will be the way updates
occur, once it's done. Until then, updates are manual, with these steps:

1. Update each URL and checksum in `src/microsoft/versions.json`.
1. Delete the Dockerfile directories in `src/microsoft`.
   * This ensures Dockerfiles for old unsupported versions of Go are cleaned up
     (removed from the repo), like they are in upstream.
1. Run `eng/update-dockerfiles.sh`.
1. Update `/manifest.json` if any version numbers change.
   * This step will be removed once the manifest file is generated by the
     `versions.json` file: [#160](https://github.com/microsoft/go/issues/160).
1. Check in all changes, submit PR.

## Change containment

Similarly to the Go branches in the microsoft/go repo, our infrastructure is
normally kept inside the `eng` directory. This helps to isolate and easily
contribute changes to the upstream repository.

However, there are places outside of `eng` that are modified to fit
infrastructure requirements, including:

* `/*.md` - The Microsoft GitHub organization has standard repository text that
  needs to be in these files, so the upstream repo text is changed.
* `/.github` - Contains CI configuration. GitHub automatically detects files at
  this absolute path and runs them as CI, so we need to delete them to configure
  our own CI.
* [`/manifest.json`](/manifest.json) - This is the .NET Docker manifest file,
  used to orchestrate the build. The location must be here. (It is relative to
  `eng/common`.)
* [`/src/microsoft/**`](/src/microsoft/) - The .NET Docker infrastructure
  currently makes workflows more complicated if the Dockerfiles are not located
  in a `/src/` directory. So for now, we use `src`. The goal is to move them to
  `eng` when we're able to, to reduce the number of non-`eng` directories.
  [dotnet/docker-tools#836](https://github.com/dotnet/docker-tools/issues/836).
* `/Dockerfile-*.template` - These are the template files used by upstream to
  generate the Dockerfiles. We need to make some modifications to these
  templates to make them accept our builds of Go. However, we also want to be
  aware of any changes the upstream repo makes that could conflict with our
  modifications. We modify the templates directly so merge conflicts
  automatically help us find potential problems.

To find TODO-style comments describing intentional changes to upstream files
that seem suitable to contribute, search the repo for:

```
MICROSOFT_UPSTREAM
```

You may also find `NO MICROSOFT_UPSTREAM` marking changes that wouldn't be
useful to contribute to upstream. Typically, changes marked this way have no
effect whatsoever outside the context of the Microsoft-specific infrastructure.

For a complete list of files that are modified vs. the upstream Git repository,
first make sure you have the upstream Git refs locally. One way to do this is to
set up a remote:

```sh
git remote add golang https://github.com/docker-library/golang
git fetch golang
```

Then compare `master` (for example) against the corresponding
`microsoft/docker-images` branch:

```sh
git checkout microsoft/docker-images
# '...' compares against the shared base commit for both branches.
git diff --name-status golang/master...
```

The diff is also calculated and included in every auto-merge PR description. You
can use this query to find the most recent `microsoft/docker-images` auto-merge PR:
<https://github.com/microsoft/go/pulls?q=is%3Apr+author%3Amicrosoft-golang-bot+%22Merge+upstream%22>