# Copyright (c) Microsoft Corporation.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

# This job runs a specific builder on Linux.

parameters:
  # { os, arch, config }
  builder: {}

jobs:
  - job: ${{ parameters.builder.os }}_${{ parameters.builder.arch }}_${{ parameters.builder.config }}
    pool:
      # The VM image of the Docker host. This doesn't need to match the container image, but it may
      # give slightly better coverage by matching the kernel version.
      vmImage: ubuntu-18.04
    # The image used for the container this job runs in. The tests run in this container, so it
    # should match what we support as closely as possible.
    container: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-18.04-20210223192210-047508b
    workspace:
      clean: all
    steps:
      - template: ../steps/checkout-unix-task.yml

      # Initialize stage 0 toolset ahead of time so we can track timing data separately from the
      # build operations. When we call this script again later, it won't download Go again.
      - script: eng/init-stage0.sh
        displayName: Init stage 0 Go toolset

      - script: |
          set -ex

          eng/run-util.sh run-builder \
            -builder '${{ parameters.builder.os }}-${{ parameters.builder.arch }}-${{ parameters.builder.config }}' \
            -junitfile '$(Build.SourcesDirectory)/eng/artifacts/TestResults.xml'
        displayName: Run ${{ parameters.builder.config }}

      - ${{ if ne(parameters.builder.config, 'buildandpack') }}:
        - task: PublishTestResults@2
          displayName: Publish test results
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: JUnit
            testResultsFiles: $(Build.SourcesDirectory)/eng/artifacts/TestResults.xml
            testRunTitle: ${{ parameters.builder.os }}_${{ parameters.builder.arch }}_${{ parameters.builder.config }}
            buildPlatform: ${{ parameters.builder.arch }}
            buildConfiguration: ${{ parameters.builder.config }}
            publishRunAttachments: true

      - ${{ if eq(parameters.builder.config, 'buildandpack' ) }}:
        - publish: eng/artifacts/bin
          artifact: Binaries ${{ parameters.builder.os }}_${{ parameters.builder.arch }}_${{ parameters.builder.config }}
          displayName: Pipeline publish
          condition: succeededOrFailed()
